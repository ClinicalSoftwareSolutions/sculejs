(function(){"undefined"==typeof Scule&&(Scule={namespaces:{}});Scule.registerNamespace=function(a,c){if(a in Scule)throw"namespace "+a+" is already registered";Scule[a]=c};Scule.registerComponent=function(a,c,b,d){var e=Scule.require(a);if(!(c in e))throw"type "+c+" is not registered inside "+a+" namespace";e[c][b]=d};Scule.require=function(a){if(!(a in Scule))throw"namespace "+a+" has not been registered, require failed";return Scule[a]};Scule.registerNamespace("global",{constants:{INDEX_TYPE_BTREE:0,
INDEX_TYPE_RTREE:1,INDEX_TYPE_HASH:2,INDEX_TYPE_CLUSTERED:3,ID_FIELD:"_id",REF_FIELD:"_ref"},classes:{},functions:{},variables:{debug:!1}});Scule.registerNamespace("datastructures",{constants:Scule.require("global").constants,classes:{},$f:Scule.require("global").functions});Scule.registerNamespace("instrumentation",{constants:Scule.require("global").constants,classes:{}});Scule.registerNamespace("parser",{constants:Scule.require("global").constants,classes:{},variables:{lineNo:-1},symbols:{table:{}},
arities:{expression:-1,logical:0,binary:1,selective:2,negative:3,range:4,mutate:5,array:6,geospatial:7,variable:8,operand:9,index:10},$f:Scule.require("global").functions});Scule.registerNamespace("vm",{constants:Scule.require("global").constants,functions:{},classes:{},instructions:{table:{},mapping:{},index:{}},variables:{line:0,inst:0},$f:Scule.require("global").functions,$d:Scule.require("datastructures"),$p:Scule.require("parser")});Scule.registerNamespace("db",{constants:Scule.require("global").constants,
functions:{},classes:{},plugins:{},engines:{},objects:{core:{collections:{}}},$f:Scule.require("global").functions,$v:Scule.require("vm")})})();
(function(){Scule.global.classes.sha1=function(){this.hexcase=0;this.b64pad="";this.hex_sha1=function(a){return this.rstr2hex(this.rstr_sha1(this.str2rstr_utf8(a)))};this.hash=function(a){return this.hex_sha1(a)};this.b64_sha1=function(a){return this.rstr2b64(this.rstr_sha1(this.str2rstr_utf8(a)))};this.any_sha1=function(a,c){return this.rstr2any(this.rstr_sha1(this.str2rstr_utf8(a)),c)};this.hex_hmac_sha1=function(a,c){return this.rstr2hex(this.rstr_hmac_sha1(this.str2rstr_utf8(a),this.str2rstr_utf8(c)))};
this.b64_hmac_sha1=function(a,c){return this.rstr2b64(this.rstr_hmac_sha1(this.str2rstr_utf8(a),this.str2rstr_utf8(c)))};this.any_hmac_sha1=function(a,c,b){return this.rstr2any(this.rstr_hmac_sha1(this.str2rstr_utf8(a),this.str2rstr_utf8(c)),b)};this.sha1_vm_test=function(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==this.hex_sha1("abc").toLowerCase()};this.rstr_sha1=function(a){return this.binb2rstr(this.binb_sha1(this.rstr2binb(a),8*a.length))};this.rstr_hmac_sha1=function(a,c){var b=this.rstr2binb(a);
16<b.length&&(b=this.binb_sha1(b,8*a.length));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=b[f]^909522486,e[f]=b[f]^1549556828;b=this.binb_sha1(d.concat(this.rstr2binb(c)),512+8*c.length);return this.binb2rstr(this.binb_sha1(e.concat(b),672))};this.rstr2hex=function(a){try{this.hexcase}catch(c){hexcase=0}for(var b=this.hexcase?"0123456789ABCDEF":"0123456789abcdef",d="",e,f=0;f<a.length;f++)e=a.charCodeAt(f),d+=b.charAt(e>>>4&15)+b.charAt(e&15);return d};this.rstr2b64=function(a){try{this.b64pad}catch(c){this.b64pad=
""}for(var b="",d=a.length,e=0;e<d;e+=3)for(var f=a.charCodeAt(e)<<16|(e+1<d?a.charCodeAt(e+1)<<8:0)|(e+2<d?a.charCodeAt(e+2):0),g=0;4>g;g++)b=8*e+6*g>8*a.length?b+b64pad:b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>>6*(3-g)&63);return b};this.rstr2any=function(a,c){var b=c.length,d=[],e,f,g,h,j=Array(Math.ceil(a.length/2));for(e=0;e<j.length;e++)j[e]=a.charCodeAt(2*e)<<8|a.charCodeAt(2*e+1);for(;0<j.length;){h=[];for(e=g=0;e<j.length;e++)if(g=(g<<16)+j[e],f=Math.floor(g/
b),g-=f*b,0<h.length||0<f)h[h.length]=f;d[d.length]=g;j=h}b="";for(e=d.length-1;0<=e;e--)b+=c.charAt(d[e]);d=Math.ceil(8*a.length/(Math.log(c.length)/Math.log(2)));for(e=b.length;e<d;e++)b=c[0]+b;return b};this.str2rstr_utf8=function(a){for(var c="",b=-1,d,e;++b<a.length;)d=a.charCodeAt(b),e=b+1<a.length?a.charCodeAt(b+1):0,55296<=d&&(56319>=d&&56320<=e&&57343>=e)&&(d=65536+((d&1023)<<10)+(e&1023),b++),127>=d?c+=String.fromCharCode(d):2047>=d?c+=String.fromCharCode(192|d>>>6&31,128|d&63):65535>=d?
c+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|d&63):2097151>=d&&(c+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|d&63));return c};this.str2rstr_utf16le=function(a){for(var c="",b=0;b<a.length;b++)c+=String.fromCharCode(a.charCodeAt(b)&255,a.charCodeAt(b)>>>8&255);return c};this.str2rstr_utf16be=function(a){for(var c="",b=0;b<a.length;b++)c+=String.fromCharCode(a.charCodeAt(b)>>>8&255,a.charCodeAt(b)&255);return c};this.rstr2binb=function(a){for(var c=Array(a.length>>2),
b=0;b<c.length;b++)c[b]=0;for(b=0;b<8*a.length;b+=8)c[b>>5]|=(a.charCodeAt(b/8)&255)<<24-b%32;return c};this.binb2rstr=function(a){for(var c="",b=0;b<32*a.length;b+=8)c+=String.fromCharCode(a[b>>5]>>>24-b%32&255);return c};this.binb_sha1=function(a,c){a[c>>5]|=128<<24-c%32;a[(c+64>>9<<4)+15]=c;for(var b=Array(80),d=1732584193,e=-271733879,f=-1732584194,g=271733878,h=-1009589776,j=0;j<a.length;j+=16){for(var m=d,k=e,l=f,n=g,q=h,p=0;80>p;p++){b[p]=16>p?a[j+p]:this.bit_rol(b[p-3]^b[p-8]^b[p-14]^b[p-
16],1);var r=this.safe_add(this.safe_add(this.bit_rol(d,5),this.sha1_ft(p,e,f,g)),this.safe_add(this.safe_add(h,b[p]),this.sha1_kt(p))),h=g,g=f,f=this.bit_rol(e,30),e=d,d=r}d=this.safe_add(d,m);e=this.safe_add(e,k);f=this.safe_add(f,l);g=this.safe_add(g,n);h=this.safe_add(h,q)}return[d,e,f,g,h]};this.sha1_ft=function(a,c,b,d){return 20>a?c&b|~c&d:40>a?c^b^d:60>a?c&b|c&d|b&d:c^b^d};this.sha1_kt=function(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514};this.safe_add=function(a,
c){var b=(a&65535)+(c&65535);return(a>>16)+(c>>16)+(b>>16)<<16|b&65535};this.bit_rol=function(a,c){return a<<c|a>>>32-c}};Scule.getSHA1=function(){return new Scule.global.classes.sha1};Scule.sha1=Scule.getSHA1()})();
(function(){Scule.global.classes.md5=function(){this.md5cycle=function(a,c){var b=a[0],d=a[1],e=a[2],f=a[3],b=this.ff(b,d,e,f,c[0],7,-680876936),f=this.ff(f,b,d,e,c[1],12,-389564586),e=this.ff(e,f,b,d,c[2],17,606105819),d=this.ff(d,e,f,b,c[3],22,-1044525330),b=this.ff(b,d,e,f,c[4],7,-176418897),f=this.ff(f,b,d,e,c[5],12,1200080426),e=this.ff(e,f,b,d,c[6],17,-1473231341),d=this.ff(d,e,f,b,c[7],22,-45705983),b=this.ff(b,d,e,f,c[8],7,1770035416),f=this.ff(f,b,d,e,c[9],12,-1958414417),e=this.ff(e,f,b,
d,c[10],17,-42063),d=this.ff(d,e,f,b,c[11],22,-1990404162),b=this.ff(b,d,e,f,c[12],7,1804603682),f=this.ff(f,b,d,e,c[13],12,-40341101),e=this.ff(e,f,b,d,c[14],17,-1502002290),d=this.ff(d,e,f,b,c[15],22,1236535329),b=this.gg(b,d,e,f,c[1],5,-165796510),f=this.gg(f,b,d,e,c[6],9,-1069501632),e=this.gg(e,f,b,d,c[11],14,643717713),d=this.gg(d,e,f,b,c[0],20,-373897302),b=this.gg(b,d,e,f,c[5],5,-701558691),f=this.gg(f,b,d,e,c[10],9,38016083),e=this.gg(e,f,b,d,c[15],14,-660478335),d=this.gg(d,e,f,b,c[4],20,
-405537848),b=this.gg(b,d,e,f,c[9],5,568446438),f=this.gg(f,b,d,e,c[14],9,-1019803690),e=this.gg(e,f,b,d,c[3],14,-187363961),d=this.gg(d,e,f,b,c[8],20,1163531501),b=this.gg(b,d,e,f,c[13],5,-1444681467),f=this.gg(f,b,d,e,c[2],9,-51403784),e=this.gg(e,f,b,d,c[7],14,1735328473),d=this.gg(d,e,f,b,c[12],20,-1926607734),b=this.hh(b,d,e,f,c[5],4,-378558),f=this.hh(f,b,d,e,c[8],11,-2022574463),e=this.hh(e,f,b,d,c[11],16,1839030562),d=this.hh(d,e,f,b,c[14],23,-35309556),b=this.hh(b,d,e,f,c[1],4,-1530992060),
f=this.hh(f,b,d,e,c[4],11,1272893353),e=this.hh(e,f,b,d,c[7],16,-155497632),d=this.hh(d,e,f,b,c[10],23,-1094730640),b=this.hh(b,d,e,f,c[13],4,681279174),f=this.hh(f,b,d,e,c[0],11,-358537222),e=this.hh(e,f,b,d,c[3],16,-722521979),d=this.hh(d,e,f,b,c[6],23,76029189),b=this.hh(b,d,e,f,c[9],4,-640364487),f=this.hh(f,b,d,e,c[12],11,-421815835),e=this.hh(e,f,b,d,c[15],16,530742520),d=this.hh(d,e,f,b,c[2],23,-995338651),b=this.ii(b,d,e,f,c[0],6,-198630844),f=this.ii(f,b,d,e,c[7],10,1126891415),e=this.ii(e,
f,b,d,c[14],15,-1416354905),d=this.ii(d,e,f,b,c[5],21,-57434055),b=this.ii(b,d,e,f,c[12],6,1700485571),f=this.ii(f,b,d,e,c[3],10,-1894986606),e=this.ii(e,f,b,d,c[10],15,-1051523),d=this.ii(d,e,f,b,c[1],21,-2054922799),b=this.ii(b,d,e,f,c[8],6,1873313359),f=this.ii(f,b,d,e,c[15],10,-30611744),e=this.ii(e,f,b,d,c[6],15,-1560198380),d=this.ii(d,e,f,b,c[13],21,1309151649),b=this.ii(b,d,e,f,c[4],6,-145523070),f=this.ii(f,b,d,e,c[11],10,-1120210379),e=this.ii(e,f,b,d,c[2],15,718787259),d=this.ii(d,e,f,
b,c[9],21,-343485551);a[0]=this.add32(b,a[0]);a[1]=this.add32(d,a[1]);a[2]=this.add32(e,a[2]);a[3]=this.add32(f,a[3])};this.cmn=function(a,c,b,d,e,f){c=this.add32(this.add32(c,a),this.add32(d,f));return this.add32(c<<e|c>>>32-e,b)};this.ff=function(a,c,b,d,e,f,g){return this.cmn(c&b|~c&d,a,c,e,f,g)};this.gg=function(a,c,b,d,e,f,g){return this.cmn(c&d|b&~d,a,c,e,f,g)};this.hh=function(a,c,b,d,e,f,g){return this.cmn(c^b^d,a,c,e,f,g)};this.ii=function(a,c,b,d,e,f,g){return this.cmn(b^(c|~d),a,c,e,f,
g)};this.md51=function(a){txt="";var c=a.length,b=[1732584193,-271733879,-1732584194,271733878],d;for(d=64;d<=a.length;d+=64)this.md5cycle(b,this.md5blk(a.substring(d-64,d)));a=a.substring(d-64);var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(d=0;d<a.length;d++)e[d>>2]|=a.charCodeAt(d)<<(d%4<<3);e[d>>2]|=128<<(d%4<<3);if(55<d){this.md5cycle(b,e);for(d=0;16>d;d++)e[d]=0}e[14]=8*c;this.md5cycle(b,e);return b};this.md5blk=function(a){var c=[],b;for(b=0;64>b;b+=4)c[b>>2]=a.charCodeAt(b)+(a.charCodeAt(b+1)<<
8)+(a.charCodeAt(b+2)<<16)+(a.charCodeAt(b+3)<<24);return c};this.hex_chr="0123456789abcdef".split("");this.rhex=function(a){for(var c="",b=0;4>b;b++)c+=this.hex_chr[a>>8*b+4&15]+this.hex_chr[a>>8*b&15];return c};this.hex=function(a){for(var c=0;c<a.length;c++)a[c]=this.rhex(a[c]);return a.join("")};this.hash=function(a){return this.hex(this.md51(a))};this.add32=function(a,c){return a+c&4294967295}};Scule.getMD5=function(){return new Scule.global.classes.md5};"5d41402abc4b2a76b9719d911017c592"!=Scule.getMD5().hash("hello")&&
(Scule.global.classes.md5.add32=function(a,c){var b=(a&65535)+(c&65535);return(a>>16)+(c>>16)+(b>>16)<<16|b&65535});Scule.md5=Scule.getMD5()})();
(function(){Scule.global.functions.extractTrueValues=function(a){var c={},b;for(b in a)b.match(/^\$/)||a[b]&&(c[b]=!0);return c};Scule.global.functions.pushIfNotNull=function(a,c){c&&a.push(c)};Scule.global.functions.pushIfExists=function(a,c,b){b in c&&a.push(c[b])};Scule.global.functions.getObjectAttribute=function(a,c,b){return!(c in a)?b:a[c]};Scule.global.functions.getObjectId=function(a,c){void 0===c&&(c=!1);return c?a[Scule.global.constants.ID_FIELD].toString():a[Scule.global.constants.ID_FIELD]};
Scule.global.functions.cloneObject=function(a){var c={};Scule.global.functions.isArray(a)&&(c=[]);for(var b in a)c[b]="object"==typeof a[b]?Scule.global.functions.cloneObject(a[b]):a[b];return c};Scule.global.functions.traverseObject=function(a,c){var b=0,d=null,e=function(a){for(var c in a)if(!0===a[c]){d=c;break}else b++,e(a[c])};e(a);var f=0,g=function(a,c){if(f==b)return c;for(var d in a){if(!(d in c))return null;if(!0===a[d])return c;f++;return g(a[d],c[d])}};return[d,g(a,c)]};Scule.global.functions.sortObjectKeys=
function(a){var c={},b=[],d;for(d in a)b.push(d);b.sort(function(b,a){var c=!1;b.match(/^\$/)&&(b=b.substr(1),c=!0);var d=!1;a.match(/^\$/)&&(a=a.substr(1),d=!0);return c&&!d?1:d&&!c?-1:a>b?-1:a<b?1:0});b.forEach(function(b){c[b]=a[b]});return c};Scule.global.functions.sizeOf=function(a){var c=0,b;for(b in a)a.hasOwnProperty(b)&&c++;return c};Scule.global.functions.shuffle=function(a){var c,b,d=a.length;if(d)for(;--d;)b=Math.floor(Math.random()*(d+1)),c=a[b],a[b]=a[d],a[d]=c};Scule.global.functions.unique=
function(a){for(var c={},b=0;b<a.length;b++)c[a[b]]=!0;a=[];for(var d in c)a.push(d);return a};Scule.global.functions.contains=function(a,c){return c in a};Scule.global.functions.stringify=function(a){var c={},b;for(b in a)c[b]="function"==typeof a[b]?a[b].toString():a[b];return JSON.stringify(c)};Scule.global.functions.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)};Scule.global.functions.isInteger=function(a){return parseInt(a)==a};Scule.global.functions.isDouble=
function(a){return parseFloat(a)==a};Scule.global.functions.isScalar=function(a){return null!=a&&!(a instanceof Object)};Scule.global.functions.randomFromTo=function(a,c){return Math.floor(Math.random()*(c-a+1)+a)};Scule.global.functions.compare=function(a,c){return a===c?0:a>c?1:-1};Scule.global.functions.compareElementKey=function(a,c){return Scule.global.functions.compare(a.key,c.key)};Scule.global.functions.compareElementValue=function(a,c){return Scule.global.functions.compare(a.value,c.value)};
Scule.global.functions.compareArray=function(a,c){if(!Scule.global.functions.isArray(a)&&Scule.global.functions.isArray(c))return 1;if(Scule.global.functions.isArray(a)&&!Scule.global.functions.isArray(c))return-1;if(a.length>c.length)return 1;if(c.length>a.length)return-1;for(var b=!0,d=0,e=a.length,f=0;f<e;f++)d=Scule.global.functions.isArray(a[f])?d+Scule.global.functions.compareArray(a[f],c[f]):d+Scule.global.functions.compare(a[f],c[f]),0!=d&&(b=!1);0==d&&!b&&(d=JSON.stringify(a[0]).localeCompare(JSON.stringify(c[0])));
0<d?d=1:0>d&&(d=-1);return d};Scule.global.functions.sort=function(a,c,b){switch(a){case -1:c.sort(function(a,c){return c[b]-a[b]});break;case 0:Scule.global.functions.shuffle(c);break;case 1:c.sort(function(a,c){return a[b]-c[b]});break;case 2:c.sort(function(a,c){return c[b]>a[b]?-1:c[b]<a[b]?1:0});break;case 3:c.sort(function(a,c){return c[b]<a[b]?-1:c[b]>a[b]?1:0})}};Scule.global.functions.trim=function(a){return String.prototype.trim?a.trim():a.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g,
" ")};Scule.global.functions.getMACAddress=function(){if("undefined"!==typeof Titanium)return Titanium.Platform.macaddress;"SimulatedMacAddress"in Scule.global.variables||(Scule.global.variables.SimulatedMacAddress=(new Date).getTime().toString().substring(9,11)+""+Scule.global.functions.randomFromTo(100,999));return Scule.global.variables.SimulatedMacAddress};Scule.global.functions.parseAttributes=function(a){if(!Scule.global.functions.isArray(a))return Scule.global.functions.parseAttributes(a.split(","));
var c=function(b,a,f){var g=Scule.global.functions.trim(a[f]);if(f==a.length-1)b[g]=!0;else{var h={};b[g]=h;c(h,a,f+1)}},b={};a.forEach(function(a){c(b,a.split("."),0)});return b};Scule.global.functions.searchObject=function(a,c){var b=function(a,c,d){for(var h in a)!0==a[h]?Scule.global.functions.isInteger(h)&&Scule.global.functions.isArray(c)?d.push(c[h]):h in c&&d.push(c[h]):h in c&&!Scule.global.functions.isScalar(c[h])&&b(a[h],c[h],d)},d=[];b(a,c,d);return d}})();
(function(){Scule.datastructures.classes.LinkedList=function(){this.tail=this.head=null;this.length=0;this.getHead=function(){return this.head};this.getTail=function(){return this.tail};this.getLength=function(){return this.length};this.isEmpty=function(){return 0==this.length};this.clear=function(){this.tail=this.head=null;this.length=0};this.get=function(a){if(0>a||a>this.length)return null;if(0==a)return this.head;for(var c=this.head,b=0;c&&a!=b;)b++,c=c.next;return c};this.add=function(a){a=new Scule.datastructures.classes.LinkedListNode(null,
a);if(null==this.head)this.head=a;else if(null==this.tail)this.tail=this.head.next=a;else{var c=this.tail;c.next=a;this.tail=c.next}this.length++;return a};this.search=function(a,c,b){b||(b=Scule.global.functions.compare);for(var d=this.head;d;){if(c){if(0==b(d.element[c],a))break}else if(0==b(d.element,a))break;d=d.next}return d};this.contains=function(a,c){if(null==a)return!1;c||(c=Scule.global.functions.compare);for(var b=this.head;b&&0!=c(b.element,a);)b=b.next;return null!==b};this.split=function(a){var c;
if(void 0===a){if(a=Math.floor(this.length/2),c=this.middle(),!c)return null}else{if(1>a||a>this.length)return null;c=this.get(a-1)}var b=new Scule.datastructures.classes.LinkedList;b.head=c.next;c.next=null;b.tail=this.tail;this.tail=c;b.length=a;this.length-=a;return b};this.middle=function(){if(!this.head)return null;for(var a=this.head,c=this.head;c.next&&c.next.next;)a=a.next,c=c.next.next;return a};this.remove=function(a){if(0>a||a>this.length)return null;if(1==this.length)a=this.head,this.clear();
else{var c=this.get(a-1);c.next==this.tail?(a=this.tail,this.tail=c):(a=c.next,c.next=c.next.next);this.length--}return a};this.reverse=function(){for(var a=null,c=this.head,b=null;c;)b=c.next,c.next=a,a=c,c=b;b=this.head;this.head=this.tail;this.tail=b};this.toArray=function(){for(var a=[],c=this.head;c;)a.push(c.element),c=c.next;return a};this.forEach=function(a){for(var c=this.head;c;)a(c),c=c.next;return!0};this.sort=function(a,c){if(2>this.length)return this;a||(a=Scule.global.functions.compare);
var b=function(d){if(!d||!d.next)return d;var e;if(d){var f=d;for(e=d;e.next&&e.next.next;)f=f.next,e=e.next.next;e=f}else e=d;f=e.next;e.next=null;d=b(d);for(var f=b(f),g=e={next:null},h,j;d&&f;)c?(h=f.element[c],j=d.element[c]):(h=f.element,j=d.element),-1<a(h,j)?(g.next=d,d=d.next):(g.next=f,f=f.next),g=g.next;g.next=!d?f:d;return e.next};this.head=b(this.head)}};Scule.datastructures.classes.DoublyLinkedList=function(){this.tail=this.head=null;this.length=0;this.getHead=function(){return this.head};
this.getTail=function(){return this.tail};this.isEmpty=function(){return 0==this.length};this.getLength=function(){return this.length};this.search=function(a,c,b){b||(b=Scule.global.functions.compare);for(var d=this.head;d;){if(c){if(0==b(d.element[c],a))break}else if(0==b(d.element,a))break;d=d.next}return d};this.contains=function(a,c){if(null==a)return!1;c||(c=Scule.global.functions.compare);for(var b=this.head;b&&0!=c(b.element,a);)b=b.next;return null!==b};this.get=function(a){if(0>a||a>this.length)return null;
if(0==a)return this.head;for(var c=this.head,b=0;c&&a!=b;)b++,c=c.next;return c};this.add=function(a){a=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,a);if(this.isEmpty())this.head=a;else if(this.tail){var c=this.tail;c.next=a;a.prev=c;this.tail=a}else this.tail=a,this.tail.prev=this.head,this.head.next=a;this.length++;return a};this.remove=function(a){if(0>a||a>this.length)return null;if(1==this.length)a=this.head,this.clear();else{var c=this.get(a-1);c.next==this.tail?(a=this.tail,
this.tail=c,this.tail.prev=a.prev,this.tail.next=null):(a=c.next,c.next=c.next.next,c.next&&(c.next.prev=c));this.length--}a&&a.detach();return a};this.trim=function(){return this.isEmpty()?null:this.remove(this.length-1)};this.split=function(a){var c;if(void 0===a){if(a=Math.floor(this.length/2),c=this.middle(),!c)return null}else{if(1>a||a>this.length)return null;c=this.get(a-1)}var b=new Scule.datastructures.classes.DoublyLinkedList;b.head=c.next;c.next=null;c.prev=null;b.tail=this.tail;this.tail=
c;b.length=a;this.length-=a;return b};this.middle=function(){if(!this.head)return null;for(var a=this.head,c=this.head;c.next&&c.next.next;)a=a.next,c=c.next.next;return a};this.sort=function(a,c){if(2>this.length)return this;a||(a=Scule.global.functions.compare);var b=function(d){if(!d||!d.next)return d;var e;if(d){var f=d;for(e=d;e.next&&e.next.next;)f=f.next,e=e.next.next;e=f}else e=d;f=e.next;e.next=null;f.prev=null;d=b(d);for(var f=b(f),g=e={next:null},h,j;d&&f;)c?(h=f.element[c],j=d.element[c]):
(h=f.element,j=d.element),-1<a(h,j)?(g.next=d,g.prev=f,d=d.next):(g.next=f,g.prev=d,f=f.next),g=g.next;g.next=!d?f:d;return e.next};this.head=b(this.head)};this.reverse=function(){for(var a=this.head,c=null;a;)c=a.next,a.next=a.prev,a=a.prev=c;c=this.head;this.head=this.tail;this.tail=c};this.prepend=function(a){a=new Scule.datastructures.classes.DoublyLinkedListNode(null,null,a);if(this.isEmpty())this.head=a;else{var c=this.head;this.head=a;c.prev=this.head;this.head.next=c;this.tail||(this.tail=
c)}this.length++;return a};this.clear=function(){this.tail=this.head=null;this.length=0};this.toArray=function(){for(var a=[],c=this.head;c;)a.push(c.element),c=c.next;return a};this.forEach=function(a){for(var c=this.head;c;)a(c),c=c.next;return!0}};Scule.datastructures.classes.CachingLinkedList=function(a,c,b){if(!c)throw"A valid cache key is required to use a CachingLinkedList";a||(a=100);this.cacheKey=c;this.threshold=a;this.cache=new Scule.datastructures.classes.LRUCache(a);b||(b=new Scule.datastructures.classes.LinkedList);
this.list=b;this.clear=function(){this.cache.clear();this.list.clear()};this.remove=function(b){(b=this.list.remove(b))&&this.cache.remove(b.element[this.cacheKey]);return b};this.middle=function(){return this.list.middle()};this.split=function(){this.cache.clear();return this.list.split()};this.add=function(b){b=this.list.add(b);this.cache.put(b.element[this.cacheKey],b);return b};this.search=function(b){if(this.cache.contains(b))return this.cache.get(b);(b=this.list.search(b,this.cacheKey))&&this.cache.put(b.element[this.cacheKey],
b);return b};this.getLength=function(){return this.list.getLength()};this.getTail=function(){return this.list.getTail()};this.getHead=function(){return this.list.getHead()};this.isEmpty=function(){return this.list.isEmpty()};this.get=function(b){return this.list.get(b)};this.contains=function(b){return this.list.contains(b)};this.reverse=function(){this.list.reverse()};this.sort=function(b){this.list.sort(b,this.cacheKey)};this.toArray=function(){return this.list.toArray()};this.forEach=function(b){return this.list.forEach(b)}};
Scule.datastructures.classes.LinkedListNode=function(a,c){this.next=a;this.element=c;this.getNext=function(){return this.next};this.setNext=function(b){this.next=b};this.getElement=function(){return this.element};this.setElement=function(b){this.element=b}};Scule.datastructures.classes.DoublyLinkedListNode=function(a,c,b){Scule.datastructures.classes.LinkedListNode.call(this,c,b);this.prev=a;this.getPrev=function(){return this.prev};this.setPrev=function(b){this.prev=b};this.detach=function(){this.next=
this.prev=null}};Scule.datastructures.classes.LRUCache=function(a){this.threshold=a;this.cache=new Scule.datastructures.classes.HashTable;this.queue=new Scule.datastructures.classes.DoublyLinkedList;this.contains=function(a){return this.cache.contains(a)};this.remove=function(a){if(!this.cache.contains(a))return null;var b=this.cache.get(a);this.cache.remove(a);a=b.node.prev;var d=b.node.next;a&&(a.next=d);d&&(d.prev=a);b.node.detach();this.queue.length--;return!0};this.get=function(a){if(!this.cache.contains(a))return null;
a=this.cache.get(a);a.requeue(this.queue);return a.value};this.put=function(a,b){var d;this.cache.contains(a)?(d=this.cache.get(a),d.value=b,d.node.element={key:a,value:b},d.requeue(this.queue)):(d=new Scule.datastructures.classes.LRUCacheEntry(a,b,this.queue.prepend({key:a,value:b})),this.cache.put(a,d));if(this.queue.length>this.threshold&&(d=this.queue.trim(),!this.cache.remove(d.getElement().key)))throw"LRU cache is corrupt";return!0};this.getLength=function(){return this.cache.getLength()};this.clear=
function(){this.cache.clear();this.queue.clear()}};Scule.datastructures.classes.LRUCacheEntry=function(a,c,b){this.key=a;this.value=c;this.node=b;this.getKey=function(){return this.key};this.getValue=function(){return this.value};this.getNode=function(){return this.node};this.requeue=function(b){if(this.node.prev){var a=this.node.prev,c=this.node.next;if(a.next=c)c.prev=a;this.node.detach();b.length--;this.node=b.prepend({key:this.key,value:this.value})}}};Scule.datastructures.classes.LIFOStack=function(){Scule.datastructures.classes.LinkedList.call(this);
this.push=function(a){this.head=new Scule.datastructures.classes.LinkedListNode(this.head,a);this.length++};this.pop=function(){if(this.isEmpty())return null;var a=this.head;this.head=a.next;this.length--;a.next=null;return a.getElement()};this.peek=function(){return this.isEmpty()?null:this.head.getElement()}};Scule.datastructures.classes.FIFOStack=function(){Scule.datastructures.classes.LIFOStack.call(this);this.push=this.add;this.pop=function(){if(this.isEmpty())return null;var a=this.head;this.head=
a.next;this.length--;return a.getElement()}};Scule.datastructures.classes.Queue=function(){Scule.datastructures.classes.FIFOStack.call(this);this.enqueue=this.push;this.dequeue=this.pop};Scule.datastructures.classes.HashMap=function(a){this.size=a;this.length=this.buckets=0;this.table=[];this.djb2_hash=function(a){for(var b=5381,d=a.length,e=0;e<d;e++)b=(b<<5)+b+a.charCodeAt(e);0>b&&(b*=-1);return b%this.size};this.hash=this.joaat_hash=function(a){for(var b=0,d=a.length,e=0;e<d;e++)b+=a.charCodeAt(e),
b+=b<<10,b^=b>>6;b+=b<<3;b^=b>>11;b+=b<<15;0>b&&(b*=-1);return b%this.size};this.retable=function(){var a=this.length/this.size;if(!(this.length>=this.buckets&&0.7>a)){a=this.toArray();this.clear();this.size*=2;for(var b=0;b<a.length;b++)this.put(a[b][0],a[b][1])}};this.bucket=function(a){this.table[a]||(this.buckets++,this.table[a]=new Scule.datastructures.classes.BinarySearchTree);return this.table[a]};this.put=function(a,b){var d=this.hash(a),d=this.bucket(d),e=d.insert(a,b);e&&(this.length++,
0==d.getLength()%10&&d.balance());this.retable();return e};this.contains=function(a){var b=this.hash(a);return null!==this.bucket(b).search(a)};this.get=function(a){var b=this.hash(a);a=this.bucket(b).search(a);return null===a?null:a.getData()};this.search=function(a){return this.get(a)};this.remove=function(a){var b=this.hash(a);return this.bucket(b).remove(a)?(this.length--,this.retable(),!0):!1};this.clear=function(){this.table=[];this.buckets=this.length=0};this.getLength=function(){return this.length};
this.getKeys=function(){var a=[],b=function(d){null!==d&&(a.push(d.getKey()),b(d.getLeft()),b(d.getRight()))};this.table.forEach(function(a){a&&b(a.getRoot())});return a};this.getValues=function(){var a=[],b=function(d){null!==d&&(a.push(d.getData()),b(d.getLeft()),b(d.getRight()))};this.table.forEach(function(a){a&&b(a.getRoot())});return a};this.toArray=function(){var a=[];this.table.forEach(function(b){b&&(a=a.concat(b.toArray()))});return a}};Scule.datastructures.classes.HashTable=function(){this.table=
{};this.length=0;this.put=function(a,c){this.contains(a)||this.length++;this.table[a]=c};this.get=function(a){return this.contains(a)?this.table[a]:null};this.search=function(a){return this.get(a)};this.remove=function(a){return this.contains(a)?(delete this.table[a],this.length--,!0):!1};this.contains=function(a){return a in this.table};this.clear=function(){this.table={};this.length=0};this.getLength=function(){return this.length};this.getKeys=function(){var a=[],c;for(c in this.table)a.push(c);
return a};this.getValues=function(){var a=[],c;for(c in this.table)a.push(this.table[c]);return a};this.toArray=function(){var a=[],c;for(c in this.table)a[c]=this.table[c];return a}};Scule.datastructures.classes.BPlusTreeNode=function(){this.leaf=!1;this.order=100;this.threshold=40;this.data=[];this.getOrder=function(){return this.order};this.setOrder=function(a){this.order=a};this.getMergeThreshold=function(){return this.threshold};this.setMergeThreshold=function(a){this.threshold=a};this.isLeaf=
function(){return this.leaf}};Scule.datastructures.classes.BPlusTreeLeafNode=function(a,c){Scule.datastructures.classes.BPlusTreeNode.call(this);this.leaf=!0;this.left=a;this.right=c;this.getRight=function(){return this.right};this.setRight=function(a){this.right=a};this.getLeft=function(){return this.left};this.setLeft=function(a){this.left=a};this.lookup=new Scule.datastructures.classes.LRUCache(Math.floor(this.threshold/2));this.search=function(a){var c=this.lookup.get(a);if(!c)if(c=this.sequentialSearch(a))this.lookup.put(c.key,
c);else return null;return c.value};this.sequentialSearch=function(a){var c=this.indexSearch(a),e=this.data[c];return c<this.data.length&&e.key===a?e:null};this.indexSearch=function(a){var c=this.data;if(0==c.length)return 0;var e=0,f=this.data.length-1,g=e+Math.floor((f-e)/2),h=!1;do g=e+Math.floor((f-e)/2),c[g].key<a?e=g+1:c[g].key>a?f=g:h=!0;while(e<f&&!h);return h?g:f};this.identifySiblings=function(a){for(var c={index:null,left:null,key:null,right:null},e=this.getRight(),f=this.getLeft(),g=0;g<
a.data.length;g+=2){var h=a.data[g];h==e&&(c.right=e,c.index=g-2,c.right_key=a.data[g-1],c.right_key_index=g-1);h==f&&(c.left=f,c.index=g+2,c.left_key=a.data[g+1],c.left_key_index=g+1)}null==c.index&&(c.index=2<=g?g-2:0);return c};this.getKeys=function(){var a=[];this.data.forEach(function(c){a.push(c.key)});return a};this.insert=function(a,c){var e=this.indexSearch(a);if(e==this.data.length)this.data.push({key:a,value:c});else{var f=this.data[e];f.key===a?f.value=c:f.key<a?this.data.splice(e+1,0,
{key:a,value:c}):this.data.splice(e,0,{key:a,value:c})}this.lookup.put(a,{key:a,value:c});return this.split()};this.remove=function(a,c){var e=this.indexSearch(a),f=this.data[e];return e<this.data.length&&f.key===a?(this.data.splice(e,1),this.lookup.remove(a),!c?null:this.redistribute(a,c)):null};this.redistribute=function(a,c){if(this.data.length>this.threshold)return{operation:2,oldkey:a,key:this.data[0].key};var e=this.identifySiblings(c),f=this.threshold-this.data.length,g,h,j=!1;return e.left&&
(g=e.left,h=e.left_key,j=!0,g.data.length-f>=this.threshold)?(this.data=g.data.splice(-1*f,f).concat(this.data),this.lookup.clear(),{key:this.data[0].key,oldkey:e.left_key,index:e.left_key_index,operation:0}):e.right&&(g=e.right,h=e.right_key,j=!1,g.data.length-f>=this.threshold)?(this.data=this.data.concat(g.data.splice(0,f)),this.lookup.clear(),{key:g.data[0].key,oldkey:e.right_key,index:e.right_key_index,operation:0}):this.merge(g,e.index,h,j)};this.merge=function(a,c,e,f){if(this.data.length>
this.threshold)return null;if(!a)throw"Unable to merge - no siblings";if(f)return a.data=a.data.concat(this.data.splice(0,this.data.length)),a.setRight(this.getRight()),a.getRight()&&a.getRight().setLeft(a),a.lookup.clear(),this.setLeft(null),this.setRight(null),{left:!0,index:c,node:a,key:a.data[0].key,oldkey:e,operation:1};f=this.data.splice(0,this.data.length);a.data=f.concat(a.data.splice(0,a.data.length));a.setLeft(this.getLeft());a.getLeft()&&a.getLeft().setRight(a);a.lookup.clear();this.setLeft(null);
this.setRight(null);return{left:!1,index:c,key:a.data[0].key,node:a,oldkey:e,operation:1}};this.range=function(a,c,e,f){void 0===f&&(f=!1);void 0===e&&(e=!1);void 0===a&&(a=null);void 0===c&&(c=null);var g=this,h=function(a,b,c,d,e){d.splice(d.length,0,e)},j=function(a,b,c,d,e){c>a&&d.splice(d.length,0,e)},m=function(a,b,c,d,e){e<c&&d.splice(d.length,0,e)},k=function(a,b,c,d,e){e<=c&&d.splice(d.length,0,e)},l=function(a,b,c,d,e){if(c>a)if(null!==b){if(c<b)return d.concat(e)}else return d.concat(e);
return d};e=e&&f?h:e?c?m:k:f?j:l;f=[];a:for(;g;){h=g.data;m=g.indexSearch(a);j=null===c||void 0===c?h.length-1:g.indexSearch(c);j>=h.length&&(j=h.length-1);if(m<=h.length)for(;m<=j;m++){if(null!==c&&h[m].key>c)break a;e(a,c,h[m].key,f,h[m].value)}g=g.getRight()}return f};this.split=function(){if(this.data.length<=this.order)return null;var a=Math.floor(this.data.length/2),c=new Scule.datastructures.classes.BPlusTreeLeafNode(this.getLeft());c.setOrder(this.getOrder());c.setMergeThreshold(this.getMergeThreshold());
c.data=this.data.splice(0,a);var e=new Scule.datastructures.classes.BPlusTreeLeafNode(null,this.getRight());e.setOrder(this.getOrder());e.setMergeThreshold(this.getMergeThreshold());e.data=this.data.splice(0,a+1);c.setRight(e);this.getLeft()&&this.getLeft().setRight(c);e.setLeft(c);this.getRight()&&this.getRight().setLeft(e);return{left:c,key:e.data[0].key,right:e}};this.toString=function(){return JSON.stringify(this.toArray(),null,"\t")};this.toArray=function(){for(var a={type:"leaf"},c=0;c<this.data.length;c++)a[c+
":"+this.data[c].key]=this.data[c];return a}};Scule.datastructures.classes.BPlusTreeInteriorNode=function(){Scule.datastructures.classes.BPlusTreeNode.call(this);this.nodeSearch=function(a){for(var c=this.data.length,b=1;b<c;b+=2){var d=this.data[b];if(d==a)return b+1;if(d>=a)return b-1}return c-1};this.indexSearch=function(a){for(var c=this.data.length,b=1;b<c;b+=2){var d=this.data[b];if(d==a||d>=a)return b}return c-2};this.childSearch=function(a){return 0==this.data.length?null:this.data[this.nodeSearch(a)]};
this.search=function(a){return this.childSearch(a).search(a)};this.range=function(a,c,b,d){return this.childSearch(a).range(a,c,b,d)};this.insert=function(a,c){var b=this.indexSearch(a);this.data[b]>a?b--:b++;var d=this.data[b].insert(a,c);d&&this.data.splice(b,1,d.left,d.key,d.right);return this.split()};this.split=function(){if(Math.floor((this.data.length-1)/2)<this.order)return null;var a=Math.floor((this.data.length-1)/2),c=new Scule.datastructures.classes.BPlusTreeInteriorNode(this.left,null);
c.setOrder(this.order);c.setMergeThreshold(this.threshold);c.data=this.data.splice(0,a);var b=new Scule.datastructures.classes.BPlusTreeInteriorNode(null,this.right);b.setOrder(this.order);b.setMergeThreshold(this.threshold);b.data=this.data.splice(1,a);return{left:c,key:this.data[0],right:b}};this.remove=function(a,c){var b=this.indexSearch(a),d=b,d=this.data[b]>a?b-1:b+1,b=this.data[d].remove(a,this);if(!b)return null;switch(b.operation){case 1:if(3==this.data.length)return b.node;d=b.index;b.left&&
(d=b.index-2);this.data.splice(d,3,b.node);break;case 2:for(var d=!1,e=1;e<this.data.length;e+=2)this.data[e]==b.oldkey&&(this.data[e]=b.key,d=!0);if(!d)return!c?null:b}this.reassignKeys();return this.merge(c,b.key,a)};this.reassignKeys=function(){for(var a=2;a<this.data.length;a+=2)this.data[a].isLeaf()&&(this.data[a-1]=this.data[a].data[0].key)};this.merge=function(a,c,b){if(!a)return null;if(Math.floor((this.data.length-1)/2)>=this.threshold-1)return{key:c,oldkey:b,operation:2};var d,e;c=!1;for(b=
0;b<a.data.length;b+=2)if(a.data[b]==this){0==b||b<a.data.length-1?(e=a.data[b+2],d=b+1):(c=!0,e=a.data[b-2],d=b-1);break}a=a.data[d];d=new Scule.datastructures.classes.BPlusTreeInteriorNode;d.setOrder(this.getOrder());d.setMergeThreshold(this.getMergeThreshold());c?(d.data=e.data.splice(0,e.data.length),d.data=d.data.concat(a),d.data=d.data.concat(this.data.splice(0,this.data.length))):(d.data=this.data.splice(0,this.data.length),d.data=d.data.concat(a),d.data=d.data.concat(e.data.splice(0,e.data.length)));
return{left:c,node:d,index:b,oldkey:a,operation:1}};this.toString=function(){return JSON.stringify(this.toArray(),null,"\t")};this.toArray=function(){for(var a={type:"interior"},c=0,b=1;b<this.data.length;)a[b+":"+this.data[b]]={left:this.data[c].toArray(),right:this.data[c+2].toArray()},c+=2,b+=2;return a}};Scule.datastructures.classes.BPlusTree=function(a,c){a||(a=100);c||(c=Math.ceil(a/2));this.order=a;this.threshold=c;this.root=new Scule.datastructures.classes.BPlusTreeLeafNode;this.root.setOrder(this.order);
this.root.setMergeThreshold(this.threshold);this.insert=function(a,c){var e=this.root.insert(a,c);e&&(this.root=new Scule.datastructures.classes.BPlusTreeInteriorNode,this.root.setOrder(this.order),this.root.setMergeThreshold(this.threshold),this.root.data.push(e.left),this.root.data.push(e.key),this.root.data.push(e.right));return!0};this.search=function(a){return this.root.search(a)};this.range=function(a,c,e,f){return this.root.range(a,c,e,f)};this.remove=function(a){if(a=this.root.remove(a))this.root=
a;return!0};this.clear=function(){this.root=new Scule.datastructures.classes.BPlusTreeLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold)};this.toString=function(){return this.root.toString()};this.toArray=function(){return this.root.toArray()}};Scule.datastructures.classes.BinarySearchTreeNode=function(a,c){this.right=this.left=this.parent=null;this.key=a;this.data=c;this.setParent=function(a){this.parent=a};this.getParent=function(){return this.parent};this.setLeft=
function(a){a&&(this.left=a,this.left.setParent(this))};this.getLeft=function(){return this.left};this.setRight=function(a){a&&(this.right=a,this.right.setParent(this))};this.getRight=function(){return this.right};this.getKey=function(){return this.key};this.setData=function(a){this.data=a};this.getData=function(){return this.data};this.clear=function(){this.data=null};this.remove=function(a){return!a?!1:a==this.right?(this.setRight(a.getRight()),this.getRight().setLeft(a.getLeft()),a.parent=null,
a.left=null,a.right=null,!0):a==this.left?(this.setLeft(a.getRight()),this.getLeft().setLeft(a.getLeft()),a.parent=null,a.left=null,a.right=null,!0):!1}};Scule.datastructures.classes.BinarySearchTree=function(){this.root=null;this.length=0;this.insert=function(a,c){var b=this,d=new Scule.datastructures.classes.BinarySearchTreeNode(a,c);if(null==this.root)return this.length++,this.root=d,!0;var e=function(a,c){if(a.getKey()==c.getKey())return c.setData(a.getData()),!1;a.getKey()<=c.getKey()?c.getLeft()?
e(a,c.getLeft()):(b.length++,c.setLeft(a)):c.getRight()?e(a,c.getRight()):(b.length++,c.setRight(a));return!0};return e(d,this.root)};this.search=function(a){var c=function(a,d){return!d?null:d.getKey()==a?d:d.getKey()>a?c(a,d.getLeft()):c(a,d.getRight())};return c(a,this.root)};this.remove=function(a){a=this.search(a);if(!a)return!1;if(!a.getParent())return a.getRight()?(this.root=a.getRight(),this.root.setLeft(a.getLeft())):a.getLeft()?(this.root=a.getRight(),this.root.setLeft(a.getLeft())):this.root=
null,this.length--,!0;(a=a.getParent().remove(a))&&this.length--;return a};this.balance=function(){var a=this,c=this.toArray(),b=function(c){var e=c.splice(Math.ceil(c.length/2),c.length),f=c.pop();a.insert(f[0],f[1]);0<c.length&&b(c);0<e.length&&b(e)};this.length=0;this.root=null;b(c)};this.getLength=function(){return this.length};this.toArray=function(){var a=function(c){return!c?[]:a(c.getLeft()).concat([[c.getKey(),c.getData()]]).concat(a(c.getRight()))};return a(this.root)};this.getRoot=function(){return this.root}};
Scule.getLinkedList=function(){return new Scule.datastructures.classes.LinkedList};Scule.getCachingLinkedList=function(a,c){return new Scule.datastructures.classes.CachingLinkedList(a,c)};Scule.getDoublyLinkedList=function(){return new Scule.datastructures.classes.DoublyLinkedList};Scule.getHashTable=function(){return new Scule.datastructures.classes.HashTable};Scule.getHashMap=function(a){return new Scule.datastructures.classes.HashMap(a)};Scule.getLIFOStack=function(){return new Scule.datastructures.classes.LIFOStack};
Scule.getFIFOStack=function(){return new Scule.datastructures.classes.FIFOStack};Scule.getQueue=function(){return new Scule.datastructures.classes.Queue};Scule.getLRUCache=function(a){return new Scule.datastructures.classes.LRUCache(a)};Scule.getBPlusTree=function(a,c){return new Scule.datastructures.classes.BPlusTree(a,c)};Scule.getBPlusTreeNode=function(){return new Scule.datastructures.classes.BPlusTreeNode};Scule.getBPlusTreeLeafNode=function(a,c){return new Scule.datastructures.classes.BPlusTreeLeafNode(a,
c)};Scule.getBPlusTreeInteriorNode=function(){return new Scule.datastructures.classes.BPlusTreeInteriorNode};Scule.getBinarySearchTreeNode=function(a,c){return new Scule.datastructures.classes.BinarySearchTreeNode(a,c)};Scule.getBinarySearchTree=function(){return new Scule.datastructures.classes.BinarySearchTree}})();
(function(){Scule.instrumentation.classes.Timer=function(){this.intervalCounter=0;this.intervalArray=[];this.intervals=Scule.getLIFOStack();this.resetTimer=function(){this.intervalCounter=0;this.intervalArray=[];this.intervals.clear()};this.startInterval=function(a){this.intervalCounter++;void 0==a&&(a=this.intervalCounter);this.intervals.push(new Scule.instrumentation.classes.TimerInterval(a));this.intervalArray.push(this.intervals.peek())};this.stopInterval=function(){if(this.intervals.isEmpty())return!1;
this.intervals.peek().stop();return this.intervals.pop()};this.stopAllIntervals=function(){for(;!this.intervals.isEmpty();)this.intervals.pop().stop()};this.logToConsole=function(){this.intervalArray.forEach(function(a){a.logToConsole()})}};Scule.instrumentation.classes.TimerInterval=function(a){this.startTimestamp=(new Date).getTime();this.endTimestamp=null;this.tag=a;this.stopped=function(){return null!==this.endTimestamp};this.stop=function(){this.endTimestamp=(new Date).getTime()};this.getDifference=
function(){return null==this.endTimestamp?!1:this.endTimestamp-this.startTimestamp};this.logToConsole=function(){var a=this.getDifference();!1===a&&console.log("interval "+this.tag+" is still in progress");console.log("interval "+this.tag+" lasted "+a+"ms")}};Scule.getTimer=function(){return new Scule.instrumentation.classes.Timer}})();
(function(){Scule.parser.symbols.table={$and:Scule.parser.arities.selective,$or:Scule.parser.arities.selective,$nor:Scule.parser.arities.negative,$not:Scule.parser.arities.negative,$lt:Scule.parser.arities.range,$lte:Scule.parser.arities.range,$gt:Scule.parser.arities.range,$gte:Scule.parser.arities.range,$all:Scule.parser.arities.array,$in:Scule.parser.arities.array,$nin:Scule.parser.arities.array,$eq:Scule.parser.arities.binary,$ne:Scule.parser.arities.binary,$size:Scule.parser.arities.binary,$exists:Scule.parser.arities.binary,
$within:Scule.parser.arities.geospatial,$near:Scule.parser.arities.geospatial,$set:Scule.parser.arities.mutate,$inc:Scule.parser.arities.mutate,$unset:Scule.parser.arities.mutate,$pull:Scule.parser.arities.mutate,$pullAll:Scule.parser.arities.mutate,$pop:Scule.parser.arities.mutate,$push:Scule.parser.arities.mutate,$pushAll:Scule.parser.arities.mutate,$rename:Scule.parser.arities.mutate};Scule.parser.classes.QueryTree=function(){this.root=null;this.setRoot=function(a){this.root=a};this.getRoot=function(){return this.root};
this.normalize=function(){this.root.normalize()};this.setOrs=function(a){if(0==a.length)return!1;var c=new Scule.parser.classes.QueryOperand("$and",Scule.parser.arities.selective);a.forEach(function(a){c.addChild(a)});this.root.addChild(c)};this.accept=function(a){a.visit(this)}};Scule.parser.classes.QuerySymbol=function(a,c){this.children=[];this.symbol=a;this.type=c;this.setSymbol=function(a){this.symbol=a};this.getSymbol=function(){return this.symbol};this.setType=function(a){this.type=a};this.getType=
function(){return this.type};this.addChild=function(a){this.children.push(a)};this.getChildren=function(){return this.children};this.countOperands=function(){var a=0,c=function(e){e.children.forEach(function(e){e.getType()==Scule.parser.arities.operand?a++:c(e)})};c(this);return a};this.getChild=function(a){return a>this.children.length||!this.children[a]?null:this.children[a]};this.getFirstChild=function(){return this.getChild(0)};this.hasChildren=function(){return 0<this.children.length};this.normalize=
function(){for(var a=null,c=0;c<this.children.length&&0!=this.children.length;c++)a=this.children[c],a.getType()==Scule.parser.arities.selective&&(a.hasChildren()?(a.normalize(),a.hasChildren()||(this.children.splice(c,1),c--)):(this.children.splice(c,1),c--))}};Scule.parser.classes.QueryExpression=function(){Scule.parser.classes.QuerySymbol.call(this);this.type=Scule.parser.arities.expression};Scule.parser.classes.QueryOperator=function(a,c){Scule.parser.classes.QuerySymbol.call(this,a,c)};Scule.parser.classes.QueryOperand=
function(a,c){Scule.parser.classes.QuerySymbol.call(this,a,c)};Scule.parser.classes.QueryVariable=function(a){Scule.parser.classes.QuerySymbol.call(this,a);this.type=Scule.parser.arities.variable};Scule.parser.classes.QueryIndex=function(a){Scule.parser.classes.QuerySymbol.call(this,a);this.type=Scule.parser.arities.index;this.index=null;this.range=!1;this.args=[]};Scule.parser.classes.QueryParser=function(){this.parseQuery=function(a){var c=new Scule.parser.classes.QueryTree,b=Scule.getLIFOStack(),
d=Scule.getHashTable(),e=[],f=!1,g=new Scule.parser.classes.QueryExpression;c.setRoot(g);b.push(g);var h=function(a,g){var k;k=b.peek().getType();if(Scule.global.functions.isScalar(a))k==Scule.parser.arities.variable||k==Scule.parser.arities.selective?(k=new Scule.parser.classes.QueryOperator("$eq",Scule.parser.arities.binary),b.peek().addChild(k),k.addChild(new Scule.parser.classes.QueryOperand(a,Scule.parser.arities.operand))):b.peek().addChild(new Scule.parser.classes.QueryOperand(a,Scule.parser.arities.operand));
else if(Scule.global.functions.isArray(a))if(b.peek().getType()==Scule.parser.arities.selective){var l=a.length;if(2>a.length)throw"operator "+b.peek().getSymbol()+" requires two or more sub-expression";k=0;for(var n=b.peek().getSymbol();k<l;k++){if(n in a[k])throw"operator "+b.peek().getSymbol()+" cannot be nested";h(a[k],g++)}}else{var q=Scule.getHashTable();a.forEach(function(a){q.put(a,!0)});b.peek().addChild(new Scule.parser.classes.QueryOperand(q,Scule.parser.arities.operand))}else if(k=b.peek().getSymbol(),
"$near"==k||"$within"==k){if(!("lat"in a)||!("lon"in a)||!("distance"in a))throw k+" operator requires lat, lon, and distance attributes - e.g. {lat:30, lon:-30, distance:10}";b.peek().addChild(new Scule.parser.classes.QueryOperand(a,Scule.parser.arities.operand))}else{!b.isEmpty()&&"$and"!==b.peek().getSymbol()&&(k=new Scule.parser.classes.QueryOperand("$and",Scule.parser.arities.selective),b.peek().addChild(k),b.push(k));for(l in a)l in Scule.parser.symbols.table?(k=new Scule.parser.classes.QueryOperator(l,
Scule.parser.symbols.table[l]),"$or"==l?(f=!0,e.push(k)):b.peek().addChild(k),b.push(k),h(a[l],g++),!b.isEmpty()&&"$or"==b.pop().getSymbol()&&(f=!1)):(k=new Scule.parser.classes.QueryVariable(l),f?(b.peek().addChild(k),b.push(k)):d.contains(l)?(k=d.get(l),k.getType()!==Scule.parser.arities.selective&&(k.getFirstChild().getType()!==Scule.parser.arities.selective?(n=new Scule.parser.classes.QueryOperand("$and",Scule.parser.arities.selective),n.addChild(k.getFirstChild()),k.children[0]=n,d.put(l,n)):
d.put(l,k.getFirstChild())),b.push(d.get(l))):(d.put(l,k),c.getRoot().addChild(k),b.push(k)),h(a[l],g++),b.pop());b.pop()}};h(a,0);c.setOrs(e);c.normalize();return c}};Scule.getQueryTree=function(){return new Scule.parser.classes.QueryTree};Scule.getQuerySymbol=function(a,c){return new Scule.parser.classes.QuerySymbol(a,c)};Scule.getQueryParser=function(){return new Scule.parser.classes.QueryParser}})();
(function(){Scule.vm.instructions.table={halt:0,and:1,or:2,nor:3,not:4,lt:5,lte:6,gt:7,gte:8,all:9,"in":10,nin:11,eq:12,ne:13,size:14,exists:15,within:16,near:17,set:18,unset:19,inc:20,opull:21,opullall:22,opop:23,opush:24,opushall:25,"break":26,find:27,scan:28,range:29,push:30,pop:31,shift:32,store:33,merge:34,intersect:35,start:36,jump:37,"goto":38,read:39,transpose:40,limit:41,sort:42,rread:43,rindex:44};Scule.vm.instructions.index={find:!0,range:!0,scan:!0};Scule.vm.instructions.mapping={$eq:"eq",
$ne:"ne",$gt:"gt",$gte:"gte",$lt:"lt",$lte:"lte",$in:"in",$nin:"nin",$all:"all",$size:"size",$exists:"exists",$near:"near",$within:"within",$and:"and",$or:"or",$limit:"limit",$sort:"sort",$set:"set",$unset:"unset",$inc:"inc",$push:"opush",$pushAll:"opushall",$pull:"opull",$pullAll:"opullall",$pop:"opop"};Scule.vm.classes.QueryTreeIndexSelectionVisitor=function(a){this.collection=a;this.setCollection=function(a){this.collection=a};this.getCollection=function(){return this.collection};this.visit=function(a){var b=
Scule.global.functions.cloneObject(a.getRoot());try{this.visitNode(b)}catch(d){return}a.setRoot(b)};this.visitNode=function(a){var b=Scule.getHashTable(),d=Scule.getHashTable();this.populateAttributes(a,b,d);b=b.getKeys().sort();d=d.getKeys().sort();if(!(0==b.length&&0==d.length))for(var e=null,f=this.collection.indices,g=0;g<f.length;g++){var h=f[g];(e=h.applies(d,!1))&&this.selectExactIndexes(a,e);(e=h.applies(b,!0))&&this.selectRangeIndexes(a,e)}};this.populateAttributes=function(a,b,d){var e=
this;a.children.forEach(function(a){switch(a.getType()){case Scule.parser.arities.variable:a.getFirstChild().getType()==Scule.parser.arities.selective?a.children.forEach(function(c){e.processClauses(a.getSymbol(),c,b,d)}):e.processClauses(a.getSymbol(),a,b,d);break;case Scule.parser.arities.selective:throw"sub-expressions cannot use indexes";}})};this.processClauses=function(a,b,d,e){b.children.forEach(function(b){switch(b.getType()){case Scule.parser.arities.range:d.put(a,!0);break;case Scule.parser.arities.operand:case Scule.parser.arities.binary:e.put(a,
!0)}})};this.selectExactIndexes=function(a,b){var d=new Scule.parser.classes.QueryIndex(b.$index.getName());d.index=b.$index;d.range=!1;for(var e=[],f=[],g=0;g<a.children.length;g++){var h=a.children[g],j=h.getSymbol();if(j in b.$attr&&b.$attr[j]){j=h.children;h.getFirstChild().getType()==Scule.parser.arities.selective&&(j=h.getFirstChild().children);for(h=0;h<j.length;h++)if("$eq"==j[h].getSymbol()){e.push(j[h].getFirstChild().getSymbol());f.push({i_index:g,j_index:h,carray:j,parray:a.children});
break}}}f.length===b.$index.astrings.length&&(f=f.reverse(),f.forEach(function(a){a.carray.splice(a.j_index,1);0==a.carray.length&&a.parray.splice(a.i_index,1)}),a.children.unshift(d),d.args=e.join(","))};this.selectRangeIndexes=function(a,b){if(!(1<b.$index.astrings.length)){var d=new Scule.parser.classes.QueryIndex(b.$index.getName());d.index=b.$index;d.range=!0;for(var e=[],f=0,g=[null,null],h=[null,null],j=0;j<a.children.length;j++){var m=a.children[j],k=m.getSymbol();if(k in b.$attr&&b.$attr[k]&&
m.getFirstChild()){f++;m=m.getFirstChild().children;for(k=0;k<m.length;k++){var l=m[k],n=!1;switch(l.getSymbol()){case "$gt":n=!0;g[0]=l.getFirstChild().getSymbol();h[0]=!1;break;case "$gte":n=!0;g[0]=l.getFirstChild().getSymbol();h[0]=!0;break;case "$lt":n=!0;g[1]=l.getFirstChild().getSymbol();h[1]=!1;break;case "$lte":n=!0,g[1]=l.getFirstChild().getSymbol(),h[1]=!0}n&&e.push({i_index:j,j_index:k,carray:m,parray:a.children})}}}0==e.length||f<b.$index.astrings.length||(e=e.reverse(),e.forEach(function(a){a.carray.splice(a.j_index,
1);0==a.carray.length&&a.parray.splice(a.i_index,1)}),a.children.unshift(d),d.args=g.concat(h))}}};Scule.vm.classes.SculeProgram=function(){this.blocks=[];this.last=null;this.scope=Scule.getLIFOStack();this.sortt=this.sortk=this.limit=null;this.setLimit=function(a){this.limit=a};this.setSort=function(a,c){this.sortk=a;this.sortt=c};this.openBlock=function(){var a=new Scule.vm.classes.SculeProgramBlock;this.blocks.push(a);this.scope.push(a)};this.openLoopBlock=function(){var a=new Scule.vm.classes.SculeProgramLoop;
this.blocks.push(a);this.scope.push(a)};this.openSubBlock=function(){this.scope.push(this.scope.peek().openSubBlock())};this.closeBlock=function(){this.scope.peek().hasSubBlocks()?this.scope.peek().closeSubBlock():this.scope.pop()};this.addInstruction=function(a,c){Scule.vm.variables.inst++;var b=new Scule.vm.classes.SculeInstruction(a,c);!(a in Scule.vm.instructions.index)&&this.last.opcode in Scule.vm.instructions.index&&(this.scope.peek().addInstruction(new Scule.vm.classes.SculeInstruction("intersect",
[])),this.scope.peek().addInstruction(new Scule.vm.classes.SculeInstruction("store",[])),this.openLoopBlock());this.scope.peek().addInstruction(b);this.last=b};this.toByteCode=function(){Scule.vm.variables.line=0;var a=[];this.blocks.forEach(function(c){a=a.concat(c.toByteCode())});this.last.opcode in Scule.vm.instructions.index&&(a.push((new Scule.vm.classes.SculeInstruction("intersect",[])).toByteCode()),a.push((new Scule.vm.classes.SculeInstruction("store",[])).toByteCode()),a.push((new Scule.vm.classes.SculeInstruction("transpose",
[])).toByteCode()));null!==this.sortk&&a.push((new Scule.vm.classes.SculeInstruction("sort",[this.sortk,this.sortt])).toByteCode());null!==this.limit&&a.push((new Scule.vm.classes.SculeInstruction("limit",[this.limit])).toByteCode());a.push((new Scule.vm.classes.SculeInstruction("halt",[])).toByteCode());return a};this.explain=function(){Scule.vm.variables.line=0;this.blocks.forEach(function(a){a.explain()});this.last.opcode in Scule.vm.instructions.index&&((new Scule.vm.classes.SculeInstruction("intersect",
[])).explain(),(new Scule.vm.classes.SculeInstruction("store",[])).explain(),(new Scule.vm.classes.SculeInstruction("transpose",[])).explain());null!==this.sortk&&(new Scule.vm.classes.SculeInstruction("sort",[this.sortk,this.sortt])).explain();null!==this.limit&&(new Scule.vm.classes.SculeInstruction("limit",[this.limit])).explain();(new Scule.vm.classes.SculeInstruction("halt",[])).explain()}};Scule.vm.classes.SculeProgramBlock=function(){this.instructions=[];this.blocks=[];this.scope=Scule.getLIFOStack();
this.addInstruction=function(a){this.instructions.push(a)};this.openSubBlock=function(){var a=new Scule.vm.classes.SculeProgramBlock;this.blocks.push(a);this.scope.push(a);return a};this.closeSubBlock=function(){this.scope.pop()};this.hasSubBlocks=function(){return 0<this.blocks.length};this.toByteCode=function(){var a=[];this.instructions.forEach(function(c){a=a.concat([c.toByteCode()])});this.blocks.forEach(function(c){a=a.concat(c.toByteCode())});return a};this.explain=function(){this.instructions.forEach(function(a){a.explain()});
this.blocks.forEach(function(a){a.explain()})}};Scule.vm.classes.SculeProgramLoop=function(){Scule.vm.classes.SculeProgramBlock.call(this);this.instructions.push(new Scule.vm.classes.SculeInstruction("read",[]));Scule.vm.variables.inst++;this.readIndex=Scule.vm.variables.inst;this.toByteCode=function(){var a=[];this.instructions.forEach(function(b){a=a.concat([b.toByteCode()])});this.blocks.forEach(function(b){a=a.concat(b.toByteCode())});var c=this.instructions.length-1+this.blocks.length;1<c&&("or"!==
this.instructions[this.instructions.length-1].opcode||0<this.blocks.length)&&a.push((new Scule.vm.classes.SculeInstruction("and",[c])).toByteCode());a.push((new Scule.vm.classes.SculeInstruction("shift",[])).toByteCode());a.push((new Scule.vm.classes.SculeInstruction("jump",[Scule.vm.variables.line+2])).toByteCode());a.push((new Scule.vm.classes.SculeInstruction("goto",[this.readIndex])).toByteCode());return a};this.explain=function(){this.instructions.forEach(function(a){a.explain()});this.blocks.forEach(function(a){a.explain()});
var a=this.instructions.length-1+this.blocks.length;1<a&&("or"!==this.instructions[this.instructions.length-1].opcode||0<this.blocks.length)&&(new Scule.vm.classes.SculeInstruction("and",[a])).explain();(new Scule.vm.classes.SculeInstruction("shift",[])).explain();(new Scule.vm.classes.SculeInstruction("jump",[Scule.vm.variables.line+2])).explain();(new Scule.vm.classes.SculeInstruction("goto",[this.readIndex])).explain()}};Scule.vm.classes.SculeInstruction=function(a,c){this.opcode=a;this.args=c;
this.toByteCode=function(){Scule.vm.variables.line++;return[Scule.vm.instructions.table[this.opcode],c]};this.explain=function(){var a=[];this.args.forEach(function(c){Scule.global.functions.isScalar(c)?a.push(c):"getName"in c?a.push(c.getName()):a.push(c)});console.log(Scule.vm.variables.line++ +" "+this.opcode+" "+(0<a.length?JSON.stringify(a):""))}};Scule.vm.classes.QueryCompiler=function(){this.cache=Scule.getLRUCache(30);this.parser=Scule.getQueryParser();this.visitor=new Scule.vm.classes.QueryTreeIndexSelectionVisitor;
this.compileMutate=function(a,c){var b=[];b.push([Scule.vm.instructions.table.rread,[]]);for(var d in a){if(!(Scule.vm.instructions.mapping[d]in Scule.vm.instructions.table))throw d+" is an unrecognized operator";for(var e in a[d])b.push([Scule.vm.instructions.table[Scule.vm.instructions.mapping[d]],[Scule.global.functions.parseAttributes(e),a[d][e]]])}b.push([Scule.vm.instructions.table.rindex,[c]]);b.push([Scule.vm.instructions.table["goto"],[0]]);return b};this.explainMutate=function(a,c){var b=
0;console.log(b++ +" rread");for(var d in a){if(!(Scule.vm.instructions.mapping[d]in Scule.vm.instructions.table))throw d+" is an unrecognized operator";for(var e in a[d])console.log(b++ +" "+Scule.vm.instructions.mapping[d]+" "+e+", "+JSON.stringify(a[d][e]))}console.log(b++ +" rindex "+c.getName());console.log(b++ +" goto 0")};this.compileQuery=function(a,c,b){var d=Scule.md5.hash(JSON.stringify(a));if(this.cache.contains(d))return this.cache.get(d).toByteCode();Scule.vm.variables.inst=0;this.visitor.setCollection(b);
a=this.parser.parseQuery(a);a.accept(this.visitor);c=this.compileSyntaxTree(a,c,b);this.cache.put(d,c);return c.toByteCode()};this.explainQuery=function(a,c,b){var d=Scule.md5.hash(JSON.stringify(a));this.cache.contains(d)?this.cache.get(d).explain():(Scule.vm.variables.inst=0,this.visitor.setCollection(b),a=this.parser.parseQuery(a),a.accept(this.visitor),c=this.compileSyntaxTree(a,c,b),this.cache.put(d,c),c.explain())};this.compileSyntaxTree=function(a,c,b){a=a.getRoot();var d=new Scule.vm.classes.SculeProgram;
d.openBlock();(!a.hasChildren()||a.getFirstChild().getType()!==Scule.parser.arities.index)&&d.addInstruction("scan",[b]);var e=function(a,c){var b=[c.children[0].getSymbol()];b.unshift(Scule.global.functions.parseAttributes(a.getSymbol()));d.addInstruction(Scule.vm.instructions.mapping[c.getSymbol()],b)},f=function(a){a.children.forEach(function(a){switch(a.getType()){case Scule.parser.arities.index:var c=[a.index,a.args];a.range?d.addInstruction("range",c):d.addInstruction("find",c);break;case Scule.parser.arities.selective:(c=
"$or"==a.getSymbol())&&d.openSubBlock();f(a);1<a.children.length&&d.addInstruction(Scule.vm.instructions.mapping[a.getSymbol()],[c?a.children.length:a.countOperands()]);c&&d.closeBlock();break;case Scule.parser.arities.variable:var b=0;a.children.forEach(function(c){switch(c.getType()){case Scule.parser.arities.selective:c.children.forEach(function(c){e(a,c);b++});break;case Scule.parser.arities.array:case Scule.parser.arities.range:case Scule.parser.arities.binary:case Scule.parser.arities.negative:e(a,
c),b++}});1<b&&d.addInstruction("and",[b]);break;case Scule.parser.arities.expression:d.openBlock(),f(a),d.closeBlock()}})};f(a);if("$sort"in c)for(var g in c.$sort){d.setSort(g,c.$sort[g]);break}"$limit"in c&&d.setLimit(c.$limit);d.closeBlock();return d}};Scule.vm.classes.VirtualMachine=function(){this.upsert=this.running=!1;this.dpointer=this.ipointer=0;this.registers=[];this.instructions={};this.stack=Scule.getLIFOStack();this.result=[];this.reset=function(){this.upsert=this.running=!1;this.dpointer=
this.ipointer=0;this.registers=[];this.result=[];this.stack.clear()};this.halt=function(){this.running=!1};this.resume=function(){this.running=!0;this.execute()};this.execute=function(a,c,b){a?this.registers[3]=a:a=this.registers[3];for(this.running=!0;this.running;)this.executeInstruction(a[this.ipointer]);this.running=!1;if(c){this.ipointer=this.dpointer=0;this.running=!0;for(this.upsert=b;this.running;)this.executeInstruction(c[this.ipointer])}return this.result};this.registerInstruction=function(a,
c){this.instructions[a]=c};this.registerInstruction(0,function(a){a.running=!1;a.ipointer++});this.registerInstruction(26,function(a){a.running=!1;a.ipointer++});this.registerInstruction(36,function(a){a.running=!0;a.ipointer++});this.registerInstruction(28,function(a,c){var b=c[1][0].findAll();0==b.length&&(a.running=!1);a.stack.push(b);a.ipointer++});this.registerInstruction(29,function(a,c){var b=c[1][1];a.stack.push(c[1][0].range(b[0],b[1],b[2],b[3]));a.ipointer++});this.registerInstruction(27,
function(a,c){a.stack.push(c[1][0].search(c[1][1]));a.ipointer++});this.registerInstruction(33,function(a){a.registers[0]=a.stack.pop();a.ipointer++});this.registerInstruction(40,function(a){a.result=a.registers[0];a.ipointer++});this.registerInstruction(39,function(a){a.registers[1]=a.registers[0][a.dpointer++];a.ipointer++});this.registerInstruction(32,function(a){!0===a.stack.pop()&&a.result.push(a.registers[1]);a.ipointer++});this.registerInstruction(35,function(a){if(1!=a.stack.getLength()){for(var c=
[];!a.stack.isEmpty();)c.push(a.stack.pop());c=Scule.vm.functions.intersection(c);0==c.length&&(a.running=!1);a.stack.push(c)}a.ipointer++});this.registerInstruction(1,function(a,c){var b=c[1][0],d=null;do d=null==d?a.stack.pop():d&&a.stack.pop(),b--;while(0<b);a.stack.push(d);a.ipointer++});this.registerInstruction(2,function(a,c){var b=c[1][0],d=null;do d=null==d?a.stack.pop():d||a.stack.pop(),b--;while(0<b);a.stack.push(d);a.ipointer++});this.registerInstruction(38,function(a,c){a.ipointer=c[1][0]});
this.registerInstruction(37,function(a,c){a.dpointer>=a.registers[0].length-1?a.ipointer=c[1][0]:a.ipointer++});this.registerInstruction(12,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);a.stack.push(0<b.length&&b[0]==c[1][1]);a.ipointer++});this.registerInstruction(13,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);a.stack.push(0<b.length&&b[0]!==c[1][1]);a.ipointer++});this.registerInstruction(7,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],
a.registers[1]);a.stack.push(0<b.length&&b[0]>c[1][1]);a.ipointer++});this.registerInstruction(8,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);a.stack.push(0<b.length&&b[0]>=c[1][1]);a.ipointer++});this.registerInstruction(5,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);a.stack.push(0<b.length&&b[0]<c[1][1]);a.ipointer++});this.registerInstruction(6,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);a.stack.push(0<
b.length&&b[0]<=c[1][1]);a.ipointer++});this.registerInstruction(10,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);0==b.length?a.stack.push(!1):a.stack.push(c[1][1].contains(b[0]));a.ipointer++});this.registerInstruction(11,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);0==b.length?a.stack.push(!0):a.stack.push(!c[1][1].contains(b[0]));a.ipointer++});this.registerInstruction(14,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],
a.registers[1]);a.stack.push(Scule.global.functions.isArray(b[0])&&b[0].length==c[1][1]);a.ipointer++});this.registerInstruction(15,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);a.stack.push(0<b.length&&void 0!==b[0]);a.ipointer++});this.registerInstruction(9,function(a,c){var b=Scule.global.functions.searchObject(c[1][0],a.registers[1]);if(Scule.global.functions.isArray(b[0])){var d=c[1][1];if(b[0].length<d.getLength())a.stack.push(!1);else{var e=Scule.getHashTable();
d.getKeys().forEach(function(a){e.put(a,!1)});for(d=0;d<b[0].length;d++)e.contains(b[0][d])&&e.remove(b[0][d]);a.stack.push(0==e.getLength())}}else a.stack.push(!1);a.ipointer++});this.registerInstruction(41,function(a,c){c[1][0]<a.result.length&&(a.result=a.result.splice(0,c[1][0]));a.ipointer++});this.registerInstruction(42,function(a,c){Scule.global.functions.sort(c[1][1],a.result,c[1][0]);a.ipointer++});this.registerInstruction(43,function(a){a.dpointer>=a.result.length&&a.halt();a.registers[1]=
a.result[a.dpointer];a.dpointer++;a.ipointer++});this.registerInstruction(18,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],a.registers[1]),d=b[0],b=b[1];d in b?b[d]=c[1][1]:!0==a.upsert&&(b[d]=c[1][1]);a.ipointer++});this.registerInstruction(19,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],a.registers[1]),d=b[0],b=b[1];d in b&&delete b[d];a.ipointer++});this.registerInstruction(20,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],a.registers[1]),
d=b[0],b=b[1];if(d in b){if(Scule.global.functions.isInteger(b[d])||Scule.global.functions.isDouble(b[d]))b[d]+=c[1][1]}else a.upsert&&(b[d]=c[1][1]);a.ipointer++});this.registerInstruction(21,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],a.registers[1]),d=b[0],b=b[1];if(d in b&&Scule.global.functions.isArray(b[d]))for(var e=c[1][1],f=0;f<b[d].length;f++)b[d][f]==e&&(b[d].splice(f,1),f--);a.ipointer++});this.registerInstruction(22,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],
a.registers[1]),d=b[0],b=b[1];if(d in b&&Scule.global.functions.isArray(b[d])){var e=c[1][1];if(!Scule.global.functions.isArray(e))throw"the $pullAll operator requires an associated array as an operand";var f=Scule.getHashTable();e.forEach(function(a){f.put(a,!0)});for(e=0;e<b[d].length;e++)f.contains(b[d][e])&&(b[d].splice(e,1),e--)}a.ipointer++});this.registerInstruction(23,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],a.registers[1]),d=b[0],b=b[1];d in b&&Scule.global.functions.isArray(b[d])&&
b[d].pop();a.ipointer++});this.registerInstruction(24,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],a.registers[1]),d=b[0],b=b[1];!(d in b)&&a.upsert?b[d]=c[1][1]:Scule.global.functions.isArray(b[d])&&b[d].push(c[1][1]);a.ipointer++});this.registerInstruction(25,function(a,c){var b=Scule.global.functions.traverseObject(c[1][0],a.registers[1]),d=b[0],b=b[1];if(!(d in b)&&a.upsert)b[d]=c[1][1];else{var e=c[1][1];if(!Scule.global.functions.isArray(e))throw"the $pushAll operator requires an associated array as an operand";
Scule.global.functions.isArray(b[d])&&(b[d]=b[d].concat(e))}a.ipointer++});this.registerInstruction(44,function(a,c){Scule.vm.functions.updateIndexes(a.registers[1],c[1][0]);a.ipointer++});this.registerInstruction(16,function(a,c){var b=a.registers[1],d=Scule.global.functions.traverseObject(c[1][0],b);if(2>d.length||!("loc"in d[1]))a.stack.push(!1);else if(d=d[1].loc,!("lat"in d)||!("lon"in d))a.stack.push(!1);else{var e=c[1][1],d=Math.sqrt(Math.pow(e.lat-d.lat,2)+Math.pow(e.lon-d.lon,2));d<=e.distance?
(b=Scule.global.functions.cloneObject(b),b._meta={distance:d},a.registers[1]=b,a.stack.push(!0)):a.stack.push(!1)}a.ipointer++});this.registerInstruction(17,function(a,c){var b=a.registers[1],d=Scule.global.functions.traverseObject(c[1][0],b);if(2>d.length||!("loc"in d[1]))a.stack.push(!1);else{var d=d[1].loc,e=c[1][1],f=e.distance;!("lat"in d)||!("lon"in d)?a.stack.push(!1):(d=6371*Math.acos(Math.sin(d.lat)*Math.sin(e.lat)+Math.cos(d.lat)*Math.cos(e.lat)*Math.cos(e.lon-d.lon)),d<=f?(b=Scule.global.functions.cloneObject(b),
b._meta={distance:d},a.registers[1]=b,a.stack.push(!0)):a.stack.push(!1))}a.ipointer++});this.executeInstruction=function(a){this.instructions[a[0]](this,a)}};Scule.vm.functions.updateIndexes=function(a,c){c.indices.forEach(function(c){c.remove(a);c.index(a)})};Scule.vm.functions.intersection=function(a){if(1==a.length)return a[0];var c=Scule.getHashTable(),b=null;a.forEach(function(a){if(!b||a.length<b.length)b=a});b.forEach(function(a){c.put(Scule.global.functions.getObjectId(a),{c:1,o:a})});for(var d=
[],e=a.length,f=0;f<e;f++)a[f]!=b&&a[f].forEach(function(a){var b=c.get(Scule.global.functions.getObjectId(a));b&&(b.c++,b.c==e&&d.push(a))});return d};Scule.getQueryTreeIndexSelectionVisitor=function(a){return new Scule.vm.classes.QueryTreeIndexSelectionVisitor(a)};Scule.getQueryCompiler=function(){return new Scule.vm.classes.QueryCompiler};Scule.getVirtualMachine=function(){return new Scule.vm.classes.VirtualMachine}})();
(function(){Scule.db.classes.HashBucketTable=function(){Scule.datastructures.classes.HashTable.call(this);this.insert=function(a,c){var b;this.contains(a)?(b=this.get(a),b.put(Scule.global.functions.getObjectId(c),c)):(b=Scule.getHashTable(),b.put(Scule.global.functions.getObjectId(c),c),this.put(a,b));return!0}};Scule.db.classes.BPlusTreeHashingLeafNode=function(a,c){Scule.datastructures.classes.BPlusTreeLeafNode.call(this,a,c);this.insert=function(a,c){var e,f=this.indexSearch(a);if(f==this.data.length)e=
Scule.getHashTable(),e.put(Scule.global.functions.getObjectId(c,!0),c),this.data.push({key:a,value:e});else{var g=this.data[f];g.key===a?g.value.put(Scule.global.functions.getObjectId(c,!0),c):g.key<a?(e=Scule.getHashTable(),e.put(Scule.global.functions.getObjectId(c,!0),c),this.data.splice(f+1,0,{key:a,value:e})):(e=Scule.getHashTable(),e.put(Scule.global.functions.getObjectId(c,!0),c),this.data.splice(f,0,{key:a,value:e}))}e&&this.lookup.put(a,{key:a,value:e});return this.split()};this.split=function(){if(this.data.length<=
this.order)return null;var a=Math.floor(this.data.length/2),c=new Scule.db.classes.BPlusTreeHashingLeafNode(this.getLeft());c.setOrder(this.getOrder());c.setMergeThreshold(this.getMergeThreshold());c.data=this.data.splice(0,a);var e=new Scule.db.classes.BPlusTreeHashingLeafNode(null,this.getRight());e.setOrder(this.getOrder());e.setMergeThreshold(this.getMergeThreshold());e.data=this.data.splice(0,a+1);c.setRight(e);this.getLeft()&&this.getLeft().setRight(c);e.setLeft(c);this.getRight()&&this.getRight().setLeft(e);
return{left:c,key:e.data[0].key,right:e}};this.range=function(a,c,e,f){void 0===f&&(f=!1);void 0===e&&(e=!1);void 0===a&&(a=null);void 0===c&&(c=null);var g=this,h=function(a,c,b,d,e){return d.concat(e)},j=function(a,c,b,d,e){return b>a?d.concat(e):d},m=function(a,c,b,d,e){return e<b?d.concat(e):d},k=function(a,c,b,d,e){return e<=b?d.concat(e):d},l=function(a,c,b,d,e){if(b>a)if(null!==c){if(b<c)return d.concat(e)}else return d.concat(e);return d};e=e&&f?h:e?c?m:k:f?j:l;f=[];a:for(;g;){h=g.data;m=
g.indexSearch(a);j=null===c||void 0===c?h.length-1:g.indexSearch(c);j>=h.length&&(j=h.length-1);if(m<=h.length)for(;m<=j;m++){if(null!==c&&h[m].key>c)break a;f=e(a,c,h[m].key,f,h[m].value.getValues())}g=g.getRight()}return f};this.toArray=function(){for(var a={type:"hashing-leaf"},c=0;c<this.data.length;c++)a[c+":"+this.data[c].key]=this.data[c].value;return a}};Scule.db.classes.BPlusHashingTree=function(a,c){Scule.datastructures.classes.BPlusTree.call(this,a,c);this.root=new Scule.db.classes.BPlusTreeHashingLeafNode;
this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold);this.clear=function(){this.root=new Scule.db.classes.BPlusTreeHashingLeafNode;this.root.setOrder(this.order);this.root.setMergeThreshold(this.threshold)}};Scule.db.classes.Index=function(){this.attributes={};this.astrings=Scule.getHashTable();this.leaves=Scule.getHashTable();this.type=this.structure=null;this.setAttribtues=function(a){this.attributes=a;this.attributes=Scule.global.functions.sortObjectKeys(this.attributes)};
this.parseAttributes=function(a){this.populateAttributeStrings(a);this.attributes=Scule.global.functions.parseAttributes(a);this.attributes=Scule.global.functions.sortObjectKeys(this.attributes)};this.populateAttributeStrings=function(a){var c=this;Scule.global.functions.isArray(a)||(a=a.split(","));a.forEach(function(a){c.astrings.put(a,!0)})};this.resetAttributes=function(){this.attributes={};this.clear()};this.getType=function(){return this.type};this.getName=function(){return this.astrings.getKeys().sort().join(",")};
this.applies=function(a,c){if(c&&this.getType()==Scule.global.constants.INDEX_TYPE_HASH||a.length<this.astrings.getLength())return!1;var b={$partial:!1,$none:!0,$range:c,$attr:{},$index:this},d=this;a.forEach(function(a){d.astrings.contains(a)?(b.$attr[a]=!0,b.$none=!1):(b.$partial||(b.$partial=!0),b.$attr[a]=!1)});return b.$none?!1:b};this.generateIndexKey=function(a){a=Scule.global.functions.searchObject(this.attributes,a);return 1==a.length?a[0]:a.join(",")};this.index=function(a){if(!this.structure)return!1;
var c=Scule.global.functions.getObjectId(a,!0),b=this.generateIndexKey(a);this.structure.insert(b,a);a=this.structure.search(b);this.leaves.put(c,{table:a,key:b});return!0};this.remove=function(a){if(!this.structure)return!1;a=Scule.global.functions.getObjectId(a,!0);if(!this.leaves.contains(a))return!1;var c=this.leaves.get(a);c.table.remove(a);0==c.table.getLength()&&this.structure.remove(c.key);return!0};this.removeKey=function(a){if(!this.structure)return!1;var c=this.structure.search(a);if(c&&
0<c.length){this.structure.remove(a);for(var b in c.table)this.leaves.remove(Scule.global.functions.getObjectId(c.get(b),!0))}return!0};this.search=function(a){return this.structure&&(a=this.structure.search(a))?a.getValues():[]};this.range=function(a,c,b,d){return this.structure?this.structure.range(a,c,b,d):!1};this.clear=function(){return this.structure?(this.structure.clear(),!0):!1};this.getLength=function(){return this.leaves.length}};Scule.db.classes.BPlusTreeIndex=function(a){Scule.db.classes.Index.call(this);
a||(a=100);this.structure=new Scule.db.classes.BPlusHashingTree(a);this.type=Scule.global.constants.INDEX_TYPE_BTREE};Scule.db.classes.HashTableIndex=function(){Scule.db.classes.Index.call(this);this.structure=new Scule.db.classes.HashBucketTable;this.type=Scule.global.constants.INDEX_TYPE_HASH;this.range=function(){throw"HashTable type indices to not support range query operations";}};Scule.db.classes.SimpleCryptographyProvider=function(){this.signString=function(a,c,b){return Scule.sha1.hash(Scule.sha1.hash(a+
c)+b)};this.signObject=function(a,c,b){a._sig=b;return this.signString(JSON.stringify(a),c,b)};this.signJSONString=function(a,c,b){return this.signString(JSON.stringify(a),c,b)};this.verifyObjectSignature=function(a,c,b){var d=a._sig;a=this.signObject(a,c,b);return d===a}};Scule.db.classes.StorageEngine=function(a){this.configuration=a;this.crypto=null;this.setConfiguration=function(a){this.configuration=a};this.getConfiguration=function(){return this.configuration};this.setCryptographyProvider=function(a){this.crypto=
a};this.getCryptographyProvider=function(){return this.crypto};this.write=function(){throw"function not implemented in abstract class";};this.read=function(){throw"function not implemented in abstract class";}};Scule.db.classes.DummyStorageEngine=function(a){Scule.db.classes.StorageEngine.call(this,a);this.write=function(a,b,d){d&&d(b)};this.read=function(a,b){b&&b()}};Scule.db.classes.MemoryStorageEngine=function(a){Scule.db.classes.StorageEngine.call(this,a);this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider);
this.storage={};this.write=function(a,b,d){b._salt||(b._salt=Scule.sha1.hash((new Date).getTime()+""));b._sig=this.crypto.signObject(b,this.configuration.secret,b._salt);this.storage["__scule_collection__"+a]=JSON.stringify(b);d&&d(b)};this.read=function(a,b){if(!("__scule_collection__"+a in this.storage)){var d={_sig:null,_salt:Scule.sha1.hash((new Date).getTime()+""),_version:2,_name:a,_objects:{}};d._sig=this.crypto.signObject(d,this.configuration.secret,d._salt);this.storage["__scule_collection__"+
a]=JSON.stringify(d)}d=JSON.parse(this.storage["__scule_collection__"+a]);if(!1==this.crypto.verifyObjectSignature(d,this.configuration.secret,d._salt))throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete d._sig;b&&b(d)}};Scule.db.classes.LocalStorageStorageEngine=function(a){Scule.db.classes.StorageEngine.call(this,a);this.setCryptographyProvider(new Scule.db.classes.SimpleCryptographyProvider);if(!window||!("localStorage"in window)&&null!==window.localStorage)throw JSON.stringify({event:"SculeLocalStorageError",
message:"Local storage is not available on this device"});this.write=function(a,b,d){b._salt||(b._salt=Scule.sha1.hash((new Date).getTime()+""));try{b._sig=this.crypto.signObject(b,this.configuration.secret,b._salt),localStorage.setItem("__scule_collection__"+a,JSON.stringify(b)),d&&d(b)}catch(e){throw JSON.stringify({event:"SculeLocalStorageError",message:"Storage quota exceeded for origin",collection:this.configuration.collection});}};this.read=function(a,b){var d=localStorage.getItem("__scule_collection__"+
a);if(!d)throw JSON.stringify({event:"SculeLocalStorageError",message:"Unable to load collection from local storage",collection:this.configuration.collection});d=JSON.parse(d);if(!1==this.crypto.verifyObjectSignature(d,this.configuration.secret,d._salt))throw JSON.stringify({event:"SculeDataTampered",filename:this.configuration.collection});delete d._sig;b&&b(d)}};Scule.db.classes.ObjectId=function(a){if(void 0===a){a=Math.floor((new Date).getTime()/1E3).toString(16);for(var c=Scule.md5.hash(Scule.global.functions.getMACAddress()).substring(0,
6),b=Scule.global.functions.randomFromTo(1E3,9999).toString(16);4>b.length;)b="0"+b;for(var d=Scule.global.functions.randomFromTo(1E5,999999).toString(16);6>d.length;)d="0"+d;a=a+c+b+d}this.id=a;this.$type="id";this.toString=function(){return this.id.toString()}};Scule.db.classes.ObjectDate=function(a,c){if(void 0===a&&void 0==c){var b=(new Date).getTime().toString();a=parseInt(b.substring(0,10));c=parseInt(b.substring(10))}this.ts=parseInt(a+c);this.sec=a;this.usec=c;this.$type="date";this.getTimestamp=
function(){return this.ts};this.getSeconds=function(){return this.sec};this.getMicroSeconds=function(){return this.usec}};Scule.db.classes.DBRef=function(a,c){if(void 0===a||void 0===c)throw"illegal object reference";this.ref=a;this.id=new Scule.db.classes.ObjectId(c);this.$type="dbref";this.getRef=function(){return this.ref};this.getId=function(){return this.id};this.resolve=function(){return this.resolveReference()};this.resolveReference=function(){return Scule.factoryCollection(this.ref).findOne(this.id)}};
Scule.db.classes.Collection=function(a){this.documents=Scule.getHashTable();this.compiler=Scule.getQueryCompiler();this.vm=Scule.getVirtualMachine();this.version=2;this.lastId=null;this.name=a;this.isOpen=this.autoCommit=!1;this.storage=null;this.indices=[];this.setStorageEngine=function(a){this.storage=a};this.ensureIndex=function(a,b,d){var e;switch(a){case Scule.global.constants.INDEX_TYPE_BTREE:d||(d={order:100});e=new Scule.db.classes.BPlusTreeIndex(d.order);e.parseAttributes(b);break;case Scule.global.constants.INDEX_TYPE_HASH:e=
new Scule.db.classes.HashTableIndex,e.parseAttributes(b)}if(e){a=!1;b=e.astrings.length;for(d=0;d<this.indices.length;d++)if(b>this.indices[d].astrings.length){this.indices.splice(d,0,e);a=!0;break}a||(this.findAll().forEach(function(a){e.index(a)}),this.indices.push(e))}};this.ensureBTreeIndex=function(a,b){this.ensureIndex(Scule.global.constants.INDEX_TYPE_BTREE,a,b)};this.ensureHashIndex=function(a,b){this.ensureIndex(Scule.global.constants.INDEX_TYPE_HASH,a,b)};this.setAutoCommit=function(a){this.autoCommit=
a};this.getName=function(){return this.name};this.getLength=function(){return this.documents.getLength()};this.getLastInsertId=function(){return this.lastId};this.open=function(a){if(!this.isOpen){var b=this;this.storage.read(this.name,function(d){if(d){for(var e in d._objects){var f=d._objects[e];Scule.db.functions.unflattenObject(d._objects[e]);b.documents.put(Scule.global.functions.getObjectId(f,!0),f);for(var g=0;g<b.indices.length;g++)b.indices[g].index(f)}b.isOpen=!0;a&&a(this)}})}};this.commit=
function(a){this.storage.write(this.name,{_sig:null,_salt:null,_name:this.name,_version:this.version,_objects:this.documents.table},a)};this.find=function(a,b,d){if(Scule.global.constants.ID_FIELD in a)return[this.findOne(a[Scule.global.constants.ID_FIELD])];this.vm.reset();a=this.vm.execute(this.compiler.compileQuery(a,b,this));d&&d(a);return a};this.explain=function(a,b,d){this.compiler.explainQuery(a,b,this);d&&d()};this.clear=function(a){this.documents.clear();for(var b=0;b<this.indices.length;b++)this.indices[b].clear();
a&&a(this)};this.findAll=function(a){var b=[],d;for(d in this.documents.table)b.push(this.documents.get(d));a&&a(b);return b};this.findOne=function(a,b){Scule.global.functions.isScalar(a)||(a=a.toString());var d=null;this.documents.contains(a)&&(d=this.documents.get(a));b&&b(d);return d};this.save=function(a,b){Scule.db.functions.unflattenObject(a);this.documents.put(Scule.global.functions.getObjectId(a,!0),a);for(var d=0;d<this.indices.length;d++)this.indices[d].remove(a),this.indices[d].index(a);
this.autoCommit&&this.commit();this.lastId=Scule.global.functions.getObjectId(a);b&&b(this.lastId);return this.lastId};this.update=function(a,b,d,e,f){a=this.vm.execute(this.compiler.compileQuery(a,d,this),this.compiler.compileMutate(b,this),e);f&&f(a);return a};this.count=function(a,b){var d=this.find(a).length;b&&b(d);return d};this.remove=function(a,b,d){var e=this;a=this.find(a,b);a.forEach(function(a){e.documents.remove(Scule.global.functions.getObjectId(a));e.indices.forEach(function(b){b.remove(a)})});
d(a);return a};this.distinct=function(a,b,d){var e={};this.find(b).forEach(function(b){b[a]in e||(e[b[a]]=0);e[b[a]]++});d&&d(e);return e};this.merge=function(a,b){if(!a)throw"the merge function requires a valid collection as a parameter";var d=this;a.findAll().forEach(function(a){d.documents.contains(a._id)||d.documents.put(a._id,a)});b&&b(this);return!0};this.mapReduce=function(a,b,d,e){(new Scule.db.classes.MapReduceHandler(a,b,d)).run(this,e)}};Scule.db.classes.MapReduceHandler=function(a,c,b){this.options=
b;if(!a)throw"A valid function is requires as the `map` parameter of the map/reduce operation";if(!c)throw"A valid function is requires as the `reduce` parameter of the map/reduce operation";if("out"in b){if(!("merge"in b.out)&&!("reduce"in b.out))throw"A valid output collection connection url is required as either the `merge` or `reduce` out parameter of the map/reduce options object";}else throw"A valid output collection connection url is required as the `out` parameter of the map/reduce options object";
"query"in b||(b.query={});"conditions"in b||(b.conditions={});this.map=a;this.reduce=c;this.finalize="finalize"in b?b.finalize:null;this.run=function(a,b){var c=this,g="merge"in this.options.out,h=Scule.factoryCollection(g?this.options.out.merge:this.options.out.reduce),j=Scule.getHashTable(),m=function(a,b){j.contains(a)||j.put(a,[]);j.get(a).push(b)};a.find(this.options.query,this.options.conditions).forEach(function(a){c.map(a,m)});var k=null;g&&(k=Scule.factoryCollection("scule+dummy://__mr"+
(new Date).getTime()));var l=Scule.getHashTable();j.getKeys().forEach(function(a){l.put(a,c.reduce(a,j.get(a)));c.finalize&&l.put(a,c.finalize(a,l.get(a)));g?k.save(l.get(a)):h.save(l.get(a))});g&&h.merge(k);b&&b(h);return!0}};Scule.db.classes.CollectionFactory=function(){this.collections=Scule.getHashTable();this.getCollection=function(a,c){if(this.collections.contains(a))return this.collections.get(a).c;c||(c={secret:"dummy"});var b=Scule.db.functions.parseCollectionURL(a);if(!(b.plugin in Scule.db.plugins))throw b.plugin+
" is not a registered Scule plugin";if(!(b.engine in Scule.db.engines))throw b.engine+" is nto a registered Scule storage engine";var d=new Scule.db.engines[b.engine](c),b=new Scule.db.plugins[b.plugin](b.name);b.setStorageEngine(d);b.open();this.collections.put(a,{c:b,t:(new Date).getTime()});return this.collections.get(a).c}};Scule.db.functions.debug=function(a){!0==Scule.db.variables.debug&&("undefined"!==typeof Titanium?Ti.API.info(a):console.log(a))};Scule.db.functions.unflattenObject=function(a){var c=
function(a){if(!Scule.global.functions.isScalar(a))for(var d in a){var e=a[d];if(!Scule.global.functions.isScalar(e)&&"$type"in a[d])switch(e.$type){case "date":a[d]=new Scule.db.classes.ObjectDate(e.sec,e.usec);a[d].ts=e.ts;break;case "id":a[d]=new Scule.db.classes.ObjectId(e.id);break;case "dbref":a[d]=new Scule.db.classes.DBRef(e.ref,e.id)}else c(e)}};c(a);Scule.global.constants.ID_FIELD in a||(a[Scule.global.constants.ID_FIELD]=new Scule.db.classes.ObjectId)};Scule.db.functions.parseCollectionURL=
function(a){var c=a.match(/^([^\+]*)\+([^\/]*)\:\/\/(.*)/);if(!c||4!=c.length)throw a+" is an invalid collection url";return{plugin:c[1],engine:c[2],name:c[3]}};Scule.db.objects.core.collections.factory=new Scule.db.classes.CollectionFactory;Scule.debug=function(a){Scule.db.variables.debug=a};Scule.registerStorageEngine=function(a,c){if(a in Scule.db.engines)throw a+" storage engine is already registered";Scule.db.engines[a]=c};Scule.registerCollectionPlugin=function(a,c){if(a in Scule.db.plugins)throw a+
" collection plugin is already registered";Scule.db.plugins[a]=c};Scule.registerStorageEngine("memory",Scule.db.classes.MemoryStorageEngine);Scule.registerStorageEngine("dummy",Scule.db.classes.DummyStorageEngine);Scule.registerStorageEngine("local",Scule.db.classes.LocalStorageStorageEngine);Scule.registerCollectionPlugin("scule",Scule.db.classes.Collection);Scule.factoryCollection=function(a){return Scule.db.objects.core.collections.factory.getCollection(a)};Scule.dropAll=function(){Scule.db.objects.core.collections.factory.collections.clear()};
Scule.getIndex=function(){return new Scule.db.classes.Index};Scule.getHashTableIndex=function(a){return new Scule.db.classes.HashTableIndex(a)};Scule.getBPlusTreeIndex=function(a){return new Scule.db.classes.BPlusTreeIndex(a)};Scule.getObjectId=function(a){return new Scule.db.classes.ObjectId(a)};Scule.getObjectDate=function(a,c){return new Scule.db.classes.ObjectDate(a,c)};Scule.getDBRef=function(a,c){return new Scule.db.classes.DBRef(a,c)};Scule.getMemoryStorageEngine=function(a){return new Scule.db.classes.MemoryStorageEngine(a)};
Scule.getLocalStorageDiskStorageEngine=function(a){return new Scule.db.classes.LocalStorageDiskStorageEngine(a)};Scule.getSimpleCryptographyProvider=function(){return new Scule.db.classes.SimpleCryptographyProvider};Scule.getBPlusHashingTree=function(a,c){return new Scule.db.classes.BPlusHashingTree(a,c)};Scule.getHashBucketTable=function(){return new Scule.db.classes.HashBucketTable}})();